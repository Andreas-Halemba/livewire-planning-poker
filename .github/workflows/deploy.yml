name: Deploy to Production

on:
    workflow_dispatch: # Allows manual trigger from GitHub Actions UI
        inputs:
            environment:
                description: 'Deployment environment'
                required: true
                default: 'production'
                type: choice
                options:
                    - production
                    - staging

jobs:
    deploy:
        name: Deploy Application
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to known hosts
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy to Server
              env:
                  SSH_HOST: ${{ secrets.SSH_HOST }}
                  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
                  REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
                  SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
              run: |
                  echo "🚀 Deploying to ${{ inputs.environment }}..."

                  ssh -p $SSH_PORT $SSH_USERNAME@$SSH_HOST << 'ENDSSH'
                    set -e
                    
                    echo "📂 Navigating to application directory..."
                    cd ${{ secrets.REMOTE_PATH }}
                    
                    echo "📥 Pulling latest code..."
                    git pull origin main
                    
                    echo "📦 Installing Composer dependencies..."
                    composer install --no-dev --optimize-autoloader --no-interaction
                    
                    echo "📦 Installing NPM dependencies..."
                    npm ci --production=false
                    
                    echo "🔨 Building assets..."
                    npm run build
                    
                    echo "🗄️ Running database migrations..."
                    php artisan migrate --force
                    
                    echo "🧹 Clearing caches..."
                    php artisan cache:clear
                    php artisan config:clear
                    php artisan route:clear
                    php artisan view:clear
                    
                    echo "⚡ Optimizing application..."
                    php artisan config:cache
                    php artisan route:cache
                    php artisan view:cache
                    
                    echo "🔄 Restarting Reverb server..."
                    pm2 restart reverb || echo "⚠️ Could not restart reverb (maybe not running)"
                    
                    echo "✅ Deployment completed successfully!"
                  ENDSSH

            - name: Deployment Summary
              if: success()
              run: |
                  echo "✅ Deployment to ${{ inputs.environment }} completed successfully!"
                  echo "🔗 Check your application and verify everything works."

            - name: Deployment Failed
              if: failure()
              run: |
                  echo "❌ Deployment to ${{ inputs.environment }} failed!"
                  echo "Please check the logs above and fix any issues."
                  exit 1
